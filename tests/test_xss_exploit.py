import unittest
from unittest.mock import patch

from tests.tt_loader import load_tt

tt = load_tt()

XSSPayloadFactory = tt.XSSPayloadFactory
XSSPayload = tt.XSSPayload
XSSAutoVerifier = tt.XSSAutoVerifier
KNDYSFramework = tt.KNDYSFramework


class XSSProfileResolutionTests(unittest.TestCase):
    def setUp(self):
        self.framework = KNDYSFramework.__new__(KNDYSFramework)
        self.framework.config = {'user_agent': 'UnitTestAgent/1.0', 'lhost': '127.0.0.1'}
        self.framework.module_options = {}

    def test_resolve_profile_handles_listener_and_headers(self):
        self.framework.module_options = {
            'url': 'https://target.local/search?q=1',
            'method': 'post',
            'parameters': 'term',
            'injection_location': 'body',
            'payload_profile': 'aggressive',
            'custom_payload': "<img src=x onerror=alert('{{MARK}}')>",
            'encoder': 'url',
            'max_payloads': '3',
            'max_total_payloads': '10',
            'threads': '4',
            'timeout': '12',
            'throttle': '0.2',
            'verify_ssl': 'true',
            'auto_verify': 'false',
            'start_listener': 'true',
            'listener_host': '0.0.0.0',
            'listener_port': '9444',
            'listener_token': 'unit',
            'custom_headers': 'X-Test: 123',
            'cookies': 'lang=en',
            'proxies': 'http=http://127.0.0.1:8080',
            'rate_limit': '2'
        }

        profile = self.framework._resolve_xss_exploit_profile()

        self.assertEqual(profile['headers']['X-Test'], '123')
        self.assertEqual(profile['cookies']['lang'], 'en')
        self.assertEqual(profile['proxies']['http'], 'http://127.0.0.1:8080')
        self.assertTrue(profile['verify_ssl'])
        self.assertEqual(profile['payload_profile'], 'aggressive')
        self.assertEqual(profile['encoder'], 'url')
        self.assertTrue(profile['start_listener'])
        self.assertEqual(profile['listener_host'], '0.0.0.0')
        self.assertTrue(profile['rate_limiter'] is not None)


class XSSPayloadFactoryTests(unittest.TestCase):
    def test_factory_injects_beacon_and_marker(self):
        factory = XSSPayloadFactory()
        payloads = factory.generate('stealth', max_payloads=2, custom_payload='', beacon_url='http://listener/beacon')
        self.assertTrue(payloads)
        self.assertTrue(any(payload.marker in payload.payload for payload in payloads))
        self.assertTrue(all('http://listener/beacon' in payload.payload for payload in payloads))


class DummyResponse:
    def __init__(self, text, status=200):
        self.text = text
        self.status_code = status


class XSSAutoVerifierTests(unittest.TestCase):
    def setUp(self):
        self.profile = {
            'url': 'http://target.local/page?term=test',
            'method': 'get',
            'parameters': 'term',
            'body': '',
            'injection_location': 'query',
            'payload_profile': 'balanced',
            'custom_payload': '',
            'encoder': 'none',
            'threads': 1,
            'max_payloads': 1,
            'max_total_payloads': 5,
            'timeout': 5.0,
            'throttle': 0.0,
            'verify_ssl': False,
            'auto_verify': True,
            'start_listener': False,
            'listener_host': '127.0.0.1',
            'listener_port': 9090,
            'listener_token': '',
            'beacon_url': '',
            'rate_limiter': None,
            'headers': {},
            'cookies': {},
            'proxies': None,
            'report_prefix': 'xss_exploit'
        }
        marker = 'deadbeef'
        payload = XSSPayload(
            name='test',
            payload=f"<svg/onload=alert('{marker}')>",
            context='script',
            description='unit',
            tags=['test'],
            marker=marker,
            evasion=['svg']
        )
        self.payloads = [payload]

    def test_verifier_detects_reflection(self):
        def fake_request(*_args, **_kwargs):
            return DummyResponse("<html><body><script>alert('deadbeef')</script></body></html>")

        with patch('tt.requests.Session.request', side_effect=fake_request):
            verifier = XSSAutoVerifier(self.profile, self.payloads)
            result = verifier.execute()

        self.assertEqual(len(result['findings']), 1)
        finding = result['findings'][0]
        self.assertEqual(finding.reflection_type, 'script')
        self.assertEqual(finding.severity, 'High')


if __name__ == '__main__':
    unittest.main()
